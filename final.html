<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<title>SmartCane</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600;700&family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#07080f; --s1:#0d0e1a; --s2:#13152a; --s3:#1c1f38;
  --border:#252840; --accent:#4fffb0; --accent2:#ff6b6b;
  --accent3:#ffd93d; --blue:#4d9fff; --text:#e2e4f0; --muted:#5a5d7a; --r:14px;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Outfit',sans-serif;overflow:hidden}
#app{height:100dvh;display:flex;flex-direction:column;max-width:500px;margin:0 auto;position:relative}

/* TOPBAR */
#topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px 10px;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--s1);gap:8px}
#topbar h1{font-size:16px;font-weight:800;color:var(--accent);letter-spacing:-0.3px;font-family:'IBM Plex Mono',monospace;white-space:nowrap}
#topbar h1 span{color:var(--muted);font-weight:400}
#topbar-right{display:flex;align-items:center;gap:8px}
#ble-btn{display:flex;align-items:center;gap:6px;background:var(--s2);border:1px solid var(--border);border-radius:20px;padding:6px 12px;cursor:pointer;font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--muted);transition:all .2s}
#ble-btn:hover{border-color:var(--accent);color:var(--accent)}
#ble-dot{width:7px;height:7px;border-radius:50%;background:var(--muted);transition:background .3s;flex-shrink:0}
#ble-dot.connected{background:var(--accent);box-shadow:0 0 8px var(--accent)}
#ble-dot.connecting{background:var(--accent3);animation:blink 1s infinite}
/* SOS indicator in topbar */
#sos-indicator{display:none;align-items:center;gap:5px;background:rgba(255,61,90,.15);border:1px solid var(--accent2);border-radius:20px;padding:5px 10px;font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--accent2);animation:sosPulse .6s infinite alternate}
#sos-indicator.show{display:flex}
@keyframes sosPulse{from{opacity:.6}to{opacity:1}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}

/* TABS */
#tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--s1)}
.tab{flex:1;padding:10px 0;text-align:center;font-size:11px;font-weight:600;color:var(--muted);cursor:pointer;transition:all .2s;font-family:'IBM Plex Mono',monospace;letter-spacing:.5px;border-bottom:2px solid transparent}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}

/* SCREENS */
.screen{display:none;flex:1;flex-direction:column;overflow-y:auto}
.screen.active{display:flex}

/* ‚îÄ‚îÄ NAVIGATE SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#gps-bar{padding:8px 16px;background:var(--s2);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
#gps-text{font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--muted)}
#gps-text.ok{color:var(--accent)} #gps-text.err{color:var(--accent2)}
#btn-retry-gps{font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--blue);background:none;border:none;cursor:pointer;text-decoration:underline}
#room-grid-wrap{padding:14px 16px;flex-shrink:0}
#room-grid-wrap h2{font-size:11px;font-family:'IBM Plex Mono',monospace;color:var(--muted);letter-spacing:1px;margin-bottom:10px}
#room-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.room-btn{background:var(--s2);border:1px solid var(--border);border-radius:var(--r);padding:14px 12px;cursor:pointer;transition:all .2s;text-align:left;display:flex;flex-direction:column;gap:5px;position:relative;overflow:hidden}
.room-btn:hover{border-color:var(--accent);transform:translateY(-1px)}
.room-btn:active{transform:scale(.97)}
.room-btn.navigating{border-color:var(--accent);background:rgba(79,255,176,.07)}
.room-btn::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent),var(--blue));opacity:0;transition:opacity .2s}
.room-btn:hover::before,.room-btn.navigating::before{opacity:1}
.room-icon{font-size:20px} .room-name{font-size:13px;font-weight:700;color:var(--text)} .room-dist{font-size:11px;font-family:'IBM Plex Mono',monospace;color:var(--muted)}
.room-badge{position:absolute;top:7px;right:7px;background:var(--s3);border-radius:5px;padding:2px 5px;font-size:9px;font-family:'IBM Plex Mono',monospace;color:var(--muted)}
.room-badge.has-loc{background:rgba(79,255,176,.15);color:var(--accent)}
#no-rooms-msg{padding:30px 16px;text-align:center;color:var(--muted);font-size:13px;line-height:1.6}
#no-rooms-msg span{display:block;font-size:26px;margin-bottom:10px}
#nav-active{display:none;flex-direction:column;flex:1}
#nav-active.show{display:flex}
#nav-dest-bar{padding:10px 16px;background:var(--s2);border-bottom:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:space-between}
#nav-dest-name{font-size:13px;font-weight:700;color:var(--accent)}
#btn-cancel-nav{background:none;border:1px solid var(--border);border-radius:8px;padding:5px 10px;font-size:11px;color:var(--muted);cursor:pointer;font-family:'IBM Plex Mono',monospace}
#btn-cancel-nav:hover{border-color:var(--accent2);color:var(--accent2)}
#tap-zone{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;padding:16px;position:relative;overflow:hidden}
#tap-zone::after{content:'';position:absolute;inset:0;background:radial-gradient(circle at center,rgba(79,255,176,.04) 0%,transparent 70%);pointer-events:none}
#tap-hint{font-size:10px;font-family:'IBM Plex Mono',monospace;color:var(--muted);letter-spacing:2px}
#nav-arrow{font-size:80px;line-height:1;filter:drop-shadow(0 0 20px rgba(79,255,176,.3))}
#nav-arrow.pop{animation:pop .35s ease}
@keyframes pop{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
#nav-dir-label{font-size:24px;font-weight:800;color:var(--accent);letter-spacing:-0.5px}
#nav-beeps{font-family:'IBM Plex Mono',monospace;font-size:16px;color:var(--blue);letter-spacing:4px;min-height:24px}
#compass-wrap{padding:0 16px 8px;flex-shrink:0;display:flex;align-items:center;gap:12px}
#compass-ring{width:44px;height:44px;position:relative;flex-shrink:0}
#compass-ring svg{width:100%;height:100%}
#compass-status{font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--muted);line-height:1.6}
#compass-status .bearing{font-size:12px;color:var(--accent3);font-weight:700}
.obstacle-bar{padding:0 16px;min-height:0;overflow:hidden;font-family:'IBM Plex Mono',monospace;font-size:12px;font-weight:700;text-align:center;transition:all .3s;line-height:1}
.obstacle-bar.notice{padding:7px 16px;color:var(--accent3);background:rgba(255,217,61,.08);border-top:1px solid rgba(255,217,61,.2)}
.obstacle-bar.warning{padding:9px 16px;color:#ff9800;background:rgba(255,152,0,.1);border-top:1px solid rgba(255,152,0,.3);animation:obstblink .8s infinite}
.obstacle-bar.danger{padding:10px 16px;color:var(--accent2);background:rgba(255,107,107,.15);border-top:1px solid rgba(255,107,107,.4);animation:obstblink .4s infinite}
@keyframes obstblink{0%,100%{opacity:1}50%{opacity:.5}}
#step-bar{padding:6px 16px 10px;flex-shrink:0;display:flex;align-items:center;gap:10px;border-top:1px solid var(--border)}
#step-counter{font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--muted)}
#dist-remaining{font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--muted)}
#debug-panel{padding:6px 16px;background:#0a0a0f;border-top:1px solid #252840;font-family:'IBM Plex Mono',monospace;font-size:10px;color:#5a5d7a;line-height:1.8}

/* ‚îÄ‚îÄ OBSTACLE SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#screen-obstacle{gap:0;padding:16px;overflow-y:auto}
.obs-section{margin-bottom:16px}
.obs-section h2{font-size:11px;font-family:'IBM Plex Mono',monospace;color:var(--muted);letter-spacing:1px;margin-bottom:10px}

/* Big live status card */
#obs-main-card{
  background:var(--s2);border:2px solid var(--border);border-radius:var(--r);
  padding:24px 16px;text-align:center;display:flex;flex-direction:column;
  align-items:center;gap:8px;transition:border-color .3s,background .3s;margin-bottom:16px;
}
#obs-main-card.lvl1{border-color:var(--accent3);background:rgba(255,217,61,.06)}
#obs-main-card.lvl2{border-color:#ff9800;background:rgba(255,152,0,.08);animation:obstblink .8s infinite}
#obs-main-card.lvl3{border-color:var(--accent2);background:rgba(255,107,107,.12);animation:obstblink .4s infinite}
#obs-icon{font-size:52px;line-height:1}
#obs-level-label{font-size:18px;font-weight:800;letter-spacing:2px;font-family:'IBM Plex Mono',monospace}
#obs-dist-label{font-size:12px;color:var(--muted);font-family:'IBM Plex Mono',monospace}

/* Distance bar */
#obs-bar-wrap{width:100%;margin-top:4px}
#obs-bar-track{width:100%;height:8px;background:var(--s3);border-radius:4px;overflow:hidden}
#obs-bar-fill{height:100%;width:0%;border-radius:4px;transition:width .3s,background .3s;background:var(--accent)}

/* Threshold cards */
.obs-threshold-row{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px}
.obs-thresh-card{background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:12px 8px;text-align:center}
.obs-thresh-card .t-icon{font-size:20px;margin-bottom:4px}
.obs-thresh-card .t-label{font-size:10px;font-family:'IBM Plex Mono',monospace;color:var(--muted);margin-bottom:2px}
.obs-thresh-card .t-dist{font-size:13px;font-weight:700;font-family:'IBM Plex Mono',monospace}
.obs-thresh-card.notice .t-dist{color:var(--accent3)}
.obs-thresh-card.warning .t-dist{color:#ff9800}
.obs-thresh-card.danger  .t-dist{color:var(--accent2)}

/* Vibration toggle */
#vib-unlock-banner{
  background:rgba(255,217,61,.1);border:1px solid var(--accent3);border-radius:10px;
  padding:12px;text-align:center;font-size:12px;font-family:'IBM Plex Mono',monospace;
  color:var(--accent3);cursor:pointer;margin-bottom:12px;
}
#vib-unlock-banner.unlocked{background:rgba(79,255,176,.08);border-color:var(--accent);color:var(--accent)}
.toggle-row{display:flex;align-items:center;justify-content:space-between;background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:12px 14px;margin-bottom:8px}
.toggle-row span{font-size:13px;color:var(--text)}
.toggle-row small{font-size:10px;font-family:'IBM Plex Mono',monospace;color:var(--muted);display:block;margin-top:2px}
.toggle{position:relative;width:42px;height:24px;flex-shrink:0}
.toggle input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;inset:0;background:var(--s3);border-radius:12px;cursor:pointer;transition:.3s}
.toggle-slider:before{content:'';position:absolute;width:18px;height:18px;left:3px;top:3px;background:var(--muted);border-radius:50%;transition:.3s}
.toggle input:checked + .toggle-slider{background:rgba(79,255,176,.3);border:1px solid var(--accent)}
.toggle input:checked + .toggle-slider:before{transform:translateX(18px);background:var(--accent)}

/* ‚îÄ‚îÄ SOS SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#screen-sos{gap:0;padding:16px}
.sos-section{margin-bottom:14px}
.sos-section h2{font-size:11px;font-family:'IBM Plex Mono',monospace;color:var(--muted);letter-spacing:1px;margin-bottom:10px}
.field{display:flex;flex-direction:column;gap:5px;margin-bottom:10px}
.field label{font-size:11px;color:var(--muted);font-family:'IBM Plex Mono',monospace}
.inp-sos{background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:10px 13px;color:var(--text);font-family:'Outfit',sans-serif;font-size:14px;outline:none;transition:border-color .2s;width:100%}
.inp-sos:focus{border-color:var(--accent)}
.inp-sos::placeholder{color:var(--muted)}
#btn-save-sos{width:100%;padding:12px;background:rgba(79,255,176,.1);border:1px solid var(--accent);border-radius:10px;color:var(--accent);font-family:'IBM Plex Mono',monospace;font-size:12px;font-weight:700;cursor:pointer;margin-top:4px}
#save-sos-msg{font-size:10px;color:var(--accent);text-align:center;min-height:14px;margin-top:5px;font-family:'IBM Plex Mono',monospace}
#sos-status-panel{background:var(--s2);border:2px solid var(--border);border-radius:var(--r);padding:20px;text-align:center;display:flex;flex-direction:column;align-items:center;gap:8px;transition:border-color .3s,background .3s}
#sos-status-panel.active{border-color:var(--accent2);background:rgba(255,61,90,.08);animation:sosPanelPulse .5s infinite alternate}
@keyframes sosPanelPulse{from{box-shadow:0 0 0 var(--accent2)}to{box-shadow:0 0 20px rgba(255,61,90,.4)}}
#sos-emoji{font-size:44px;line-height:1}
#sos-title{font-size:14px;font-weight:700;letter-spacing:2px;font-family:'IBM Plex Mono',monospace}
#sos-sub{font-size:11px;color:var(--muted);font-family:'IBM Plex Mono',monospace}

/* ‚îÄ‚îÄ MANAGE SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#screen-manage{gap:0}
#manage-header{padding:12px 16px;flex-shrink:0;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
#manage-header h2{font-size:12px;font-family:'IBM Plex Mono',monospace;color:var(--muted);letter-spacing:.5px}
#add-form{padding:14px 16px;background:var(--s2);border-bottom:1px solid var(--border);flex-shrink:0;display:flex;flex-direction:column;gap:10px}
#add-form h3{font-size:12px;font-family:'IBM Plex Mono',monospace;color:var(--accent);letter-spacing:1px}
.form-row{display:flex;gap:8px}
.inp{flex:1;background:var(--s3);border:1px solid var(--border);border-radius:10px;padding:10px 13px;color:var(--text);font-family:'Outfit',sans-serif;font-size:14px;outline:none;transition:border-color .2s}
.inp:focus{border-color:var(--accent)} .inp::placeholder{color:var(--muted)}
.inp-icon{width:44px;background:var(--s3);border:1px solid var(--border);border-radius:10px;padding:10px 6px;color:var(--text);font-size:16px;outline:none;text-align:center}
#btn-capture-gps{width:100%;padding:11px;background:rgba(79,255,176,.12);border:1px solid var(--accent);border-radius:10px;color:var(--accent);font-family:'IBM Plex Mono',monospace;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s;letter-spacing:.5px}
#btn-capture-gps:disabled{opacity:.4;cursor:default}
#captured-coords{font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--muted);min-height:16px}
#captured-coords.ok{color:var(--accent)}
.btn-add{padding:11px;background:var(--accent);border:none;border-radius:10px;color:#07080f;font-family:'Outfit',sans-serif;font-size:14px;font-weight:800;cursor:pointer;transition:all .2s}
#room-list{padding:10px 16px;display:flex;flex-direction:column;gap:8px}
.manage-card{background:var(--s2);border:1px solid var(--border);border-radius:var(--r);padding:13px;display:flex;align-items:center;gap:12px}
.manage-card-icon{font-size:20px;width:30px;text-align:center;flex-shrink:0}
.manage-card-info{flex:1}
.manage-card-info h3{font-size:13px;font-weight:700}
.manage-card-info p{font-size:11px;font-family:'IBM Plex Mono',monospace;color:var(--muted);margin-top:2px}
.manage-card-info p.no-loc{color:var(--accent2)}
.btn-del{background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer;padding:4px;transition:color .2s}
.btn-del:hover{color:var(--accent2)}
#export-bar{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;flex-shrink:0;margin-top:auto}
.btn-io{flex:1;padding:10px;background:var(--s2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:'IBM Plex Mono',monospace;font-size:11px;cursor:pointer;transition:all .2s}
.btn-io:hover{border-color:var(--accent3);color:var(--accent3)}

/* ARRIVED overlay */
#arrived-overlay{display:none;position:fixed;inset:0;background:rgba(7,8,15,.9);backdrop-filter:blur(6px);z-index:100;flex-direction:column;align-items:center;justify-content:center;gap:14px}
#arrived-overlay.show{display:flex}
#arrived-overlay .big{font-size:64px}
#arrived-overlay h2{font-size:28px;font-weight:800;color:var(--accent)}
#arrived-overlay p{color:var(--muted);font-size:13px;font-family:'IBM Plex Mono',monospace}
#btn-dismiss{margin-top:8px;padding:13px 32px;background:var(--accent);color:#07080f;border:none;border-radius:12px;font-family:'Outfit',sans-serif;font-size:15px;font-weight:800;cursor:pointer}

/* Toast */
#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(70px);background:var(--s2);border:1px solid var(--border);border-radius:12px;padding:10px 16px;font-size:12px;font-family:'IBM Plex Mono',monospace;white-space:nowrap;transition:transform .3s cubic-bezier(.34,1.56,.64,1);z-index:999;max-width:90vw}
#toast.show{transform:translateX(-50%) translateY(0)}
#toast.ok{border-color:var(--accent);color:var(--accent)}
#toast.err{border-color:var(--accent2);color:var(--accent2)}
#toast.warn{border-color:var(--accent3);color:var(--accent3)}
#toast.info{border-color:var(--blue);color:var(--blue)}
::-webkit-scrollbar{width:3px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
</style>
</head>
<body>
<div id="app">

  <!-- TOPBAR -->
  <div id="topbar">
    <h1>SmartStick <span>v1.0</span></h1>
    <div id="topbar-right">
      <div id="sos-indicator">üÜò SOS</div>
      <div id="ble-btn" onclick="connectBLE()">
        <div id="ble-dot"></div>
        <span id="ble-label">BLE</span>
      </div>
    </div>
  </div>

  <!-- TABS -->
  <div id="tabs">
    <div class="tab active" onclick="switchTab('nav')"      id="tab-nav">NAV</div>
    <div class="tab"        onclick="switchTab('obstacle')" id="tab-obstacle">üì° OBSTACLE</div>
    <div class="tab"        onclick="switchTab('sos')"      id="tab-sos">üÜò SOS</div>
    <div class="tab"        onclick="switchTab('manage')"   id="tab-manage">ROOMS</div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NAVIGATE SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="screen-nav" class="screen active">
    <div id="gps-bar">
      <span id="gps-text">üìç Getting GPS...</span>
      <button id="btn-retry-gps" onclick="startGPS()">Retry</button>
    </div>

    <div id="room-grid-wrap">
      <h2>SELECT DESTINATION</h2>
      <div id="room-grid"></div>
      <div id="no-rooms-msg" style="display:none">
        <span>üó∫Ô∏è</span>
        No rooms yet.<br>Go to <b>ROOMS</b> tab to add locations.
      </div>
    </div>

    <div id="nav-active">
      <div id="nav-dest-bar">
        <span id="nav-dest-name">‚Äî</span>
        <button id="btn-cancel-nav" onclick="cancelNav()">‚úï Cancel</button>
      </div>
      <div id="tap-zone">
        <div id="tap-hint">üîÑ AUTO-TRACKING</div>
        <div id="nav-arrow">‚¨ÜÔ∏è</div>
        <div id="nav-dir-label">Starting...</div>
        <div id="nav-beeps"></div>
      </div>
      <div id="compass-wrap">
        <div id="compass-ring">
          <svg viewBox="0 0 48 48">
            <circle cx="24" cy="24" r="22" fill="none" stroke="#252840" stroke-width="2"/>
            <circle cx="24" cy="24" r="22" fill="none" stroke="#4fffb0" stroke-width="2"
              stroke-dasharray="138" stroke-dashoffset="138" id="compass-arc"
              style="transition:stroke-dashoffset .5s;transform-origin:center;transform:rotate(-90deg)"/>
            <polygon id="compass-needle" points="24,6 27,24 24,28 21,24"
              fill="#ffd93d" style="transform-origin:center;transition:transform .4s ease"/>
            <circle cx="24" cy="24" r="3" fill="#252840"/>
          </svg>
        </div>
        <div id="compass-status">
          <div>Heading: <span id="compass-heading">‚Äî¬∞</span></div>
          <div>Target: <span class="bearing" id="target-bearing">‚Äî¬∞</span></div>
          <div id="compass-hint" style="color:var(--accent3)">‚Äî</div>
        </div>
      </div>
      <div id="obstacle-bar" class="obstacle-bar"></div>
      <div id="step-bar">
        <span id="step-counter">‚ö° Live</span>
        <span style="flex:1"></span>
        <span id="dist-remaining">‚Äîm</span>
      </div>
      <div id="debug-panel">
        <div>GPS: <span id="dbg-gps">‚Äî</span></div>
        <div>Heading: <span id="dbg-heading">‚Äî</span> | Bearing: <span id="dbg-bearing">‚Äî</span></div>
        <div>Diff: <span id="dbg-diff">‚Äî</span> | Dist: <span id="dbg-dist">‚Äî</span></div>
        <div>Cmd: <span id="dbg-cmd" style="color:#4fffb0">‚Äî</span> | BLE: <span id="dbg-ble">‚Äî</span></div>
      </div>
    </div>
  </div><!-- /screen-nav -->

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OBSTACLE SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="screen-obstacle" class="screen">

    <!-- Live status card -->
    <div id="obs-main-card">
      <div id="obs-icon">üì°</div>
      <div id="obs-level-label">CLEAR</div>
      <div id="obs-dist-label">No obstacle detected</div>
      <div id="obs-bar-wrap">
        <div id="obs-bar-track"><div id="obs-bar-fill"></div></div>
      </div>
    </div>

    <!-- Thresholds reference -->
    <div class="obs-section">
      <h2>DETECTION ZONES</h2>
      <div class="obs-threshold-row">
        <div class="obs-thresh-card notice">
          <div class="t-icon">‚ö†Ô∏è</div>
          <div class="t-label">NOTICE</div>
          <div class="t-dist">&lt; 150cm</div>
        </div>
        <div class="obs-thresh-card warning">
          <div class="t-icon">üî∂</div>
          <div class="t-label">WARNING</div>
          <div class="t-dist">&lt; 80cm</div>
        </div>
        <div class="obs-thresh-card danger">
          <div class="t-icon">üö®</div>
          <div class="t-label">DANGER</div>
          <div class="t-dist">&lt; 30cm</div>
        </div>
      </div>
    </div>

    <!-- Vibration settings -->
    <div class="obs-section">
      <h2>VIBRATION SETTINGS</h2>

      <!-- Unlock banner ‚Äî tap to unlock vibration permission -->
      <div id="vib-unlock-banner" onclick="unlockVibration()">
        üì≥ TAP HERE FIRST to enable phone vibration
      </div>

      <div class="toggle-row">
        <div>
          <span>Vibrate on obstacle</span>
          <small>Phone vibrates when obstacle detected</small>
        </div>
        <label class="toggle">
          <input type="checkbox" id="tog-vib-obstacle" checked onchange="saveVibSettings()"/>
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="toggle-row">
        <div>
          <span>Vibrate on NOTICE only</span>
          <small>Include subtle 150cm alerts</small>
        </div>
        <label class="toggle">
          <input type="checkbox" id="tog-vib-notice" checked onchange="saveVibSettings()"/>
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="toggle-row">
        <div>
          <span>Pause nav during danger</span>
          <small>Stop direction beeps when obstacle is close</small>
        </div>
        <label class="toggle">
          <input type="checkbox" id="tog-pause-nav" checked onchange="saveVibSettings()"/>
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>

  </div><!-- /screen-obstacle -->

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SOS SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="screen-sos" class="screen">

    <div class="sos-section">
      <h2>EMERGENCY CONTACT</h2>
      <div class="field">
        <label>Contact Name</label>
        <input class="inp-sos" id="sos-inp-name" type="text" placeholder="e.g. Mum, Dad, Guardian"/>
      </div>
      <div class="field">
        <label>WhatsApp Number (with country code, no +)</label>
        <input class="inp-sos" id="sos-inp-phone" type="tel" placeholder="e.g. 601112345678"/>
      </div>
      <div class="field">
        <label>Message</label>
        <input class="inp-sos" id="sos-inp-msg" type="text" placeholder="I need help! Please come immediately."/>
      </div>
      <button id="btn-save-sos" onclick="saveSosContact()">üíæ Save Contact</button>
      <div id="save-sos-msg"></div>
    </div>

    <div class="sos-section">
      <h2>STATUS</h2>
      <div id="sos-status-panel">
        <div id="sos-emoji">üîã</div>
        <div id="sos-title">STANDBY</div>
        <div id="sos-sub">Press button on stick to trigger SOS</div>
      </div>
    </div>

  </div><!-- /screen-sos -->

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MANAGE SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="screen-manage" class="screen">
    <div id="manage-header"><h2>CAMPUS ROOMS</h2></div>
    <div id="add-form">
      <h3>+ ADD ROOM</h3>
      <div class="form-row">
        <input class="inp-icon" id="inp-icon" type="text" value="üö™" maxlength="2"/>
        <input class="inp" id="inp-name" type="text" placeholder="Room name (e.g. Lab 1)"/>
      </div>
      <button id="btn-capture-gps" onclick="captureGPS()">üìç Stand at room door ‚Üí Capture GPS</button>
      <div id="captured-coords">No location captured yet</div>
      <div class="form-row">
        <button class="btn-add" onclick="addRoom()" style="flex:1">Add Room</button>
      </div>
    </div>
    <div id="room-list"></div>
    <div id="export-bar">
      <button class="btn-io" onclick="exportMap()">‚¨Ü Export Map</button>
      <button class="btn-io" onclick="importMap()">‚¨á Import Map</button>
      <input type="file" id="import-file" accept=".json" style="display:none" onchange="handleImport(event)"/>
    </div>
  </div><!-- /screen-manage -->

</div><!-- /app -->

<!-- Arrived Overlay -->
<div id="arrived-overlay">
  <div class="big">üéØ</div>
  <h2>Arrived!</h2>
  <p id="arrived-room-name">You reached your destination.</p>
  <button id="btn-dismiss" onclick="dismissArrived()">Done</button>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SmartStick Final ‚Äî Navigation + Obstacle + SOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const BLE_SERVICE_UUID     = '12345678-1234-1234-1234-123456789abc';
const BLE_CMD_CHAR_UUID    = '12345678-1234-1234-1234-123456789ab1';
const BLE_NOTIFY_CHAR_UUID = '12345678-1234-1234-1234-123456789ab2';

// ‚îÄ‚îÄ BLE state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let bleDevice = null, cmdChar = null, notifyChar = null;
let bleConnected = false;

// ‚îÄ‚îÄ GPS / Compass state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let userLat = null, userLng = null, userHeading = null;
let capturedLat = null, capturedLng = null;
let watchId = null;

// ‚îÄ‚îÄ Room / Nav state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let rooms   = [];
let destRoom = null;

// ‚îÄ‚îÄ Obstacle state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let lastObstacleLevel = 0;
let obstacleActive    = false;
let navPaused         = false;
let vibUnlocked       = false;

// Vibration settings (loaded from localStorage)
let vibSettings = { obstacle: true, notice: true, pauseNav: true };

// ‚îÄ‚îÄ Nav direction constants ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DIR = {
  R: { label:'TURN RIGHT',  arrow:'‚û°Ô∏è', beeps:'‚ô™',     cmd:'R' },
  L: { label:'TURN LEFT',   arrow:'‚¨ÖÔ∏è', beeps:'‚ô™ ‚ô™',   cmd:'L' },
  S: { label:'GO STRAIGHT', arrow:'‚¨ÜÔ∏è', beeps:'‚ô™ ‚ô™ ‚ô™', cmd:'S' },
  U: { label:'U-TURN',      arrow:'üîÑ', beeps:'‚ô™‚ô™‚ô™‚ô™',  cmd:'U' },
  A: { label:'ARRIVED!',    arrow:'üéØ', beeps:'‚ô™‚ô™‚ô™‚ô™‚ô™', cmd:'A' },
};

// ‚îÄ‚îÄ Nav algorithm constants ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ARRIVE_THRESHOLD = 4;
const CHECK_INTERVAL   = 1000;
const REPEAT_INTERVAL  = 5000;
const TURN_THRESHOLD   = 45;
const CONFIRM_TICKS    = 3;

let navTimer    = null;
let lastSentCmd = '', lastSentTime = 0;
let navActive   = false;
let pendingNavCmd = '', pendingCount = 0;

// ‚îÄ‚îÄ Vibration patterns ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const VIBRATE = {
  1: [80],
  2: [150, 80, 150],
  3: [100,50,100,50,100,50,100,50,100],
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
  loadRooms();
  loadSosContact();
  loadVibSettings();
  startGPS();
  startCompass();
  if (!navigator.bluetooth) toast('Web Bluetooth not supported. Use Android Chrome.', 'err', 5000);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function connectBLE() {
  if (bleConnected) { disconnectBLE(); return; }
  setBleDot('connecting');
  toast('Scanning for SmartStick...', 'info');
  try {
    bleDevice = await navigator.bluetooth.requestDevice({
      filters: [{ name: 'SmartStick' }],
      optionalServices: [BLE_SERVICE_UUID]
    });
    bleDevice.addEventListener('gattserverdisconnected', onBleDisconnect);
    const server = await bleDevice.gatt.connect();
    const svc    = await server.getPrimaryService(BLE_SERVICE_UUID);
    cmdChar      = await svc.getCharacteristic(BLE_CMD_CHAR_UUID);
    notifyChar   = await svc.getCharacteristic(BLE_NOTIFY_CHAR_UUID);
    await notifyChar.startNotifications();
    notifyChar.addEventListener('characteristicvaluechanged', onBLENotify);
    bleConnected = true;
    setBleDot('connected');
    toast('SmartStick connected!', 'ok');
  } catch(e) {
    setBleDot('off');
    toast('BLE failed: ' + e.message, 'err');
  }
}

function onBleDisconnect() {
  bleConnected = false; cmdChar = null; notifyChar = null;
  setBleDot('off');
  updateObstacleUI(0, 0);
  navPaused = false;
  toast('Disconnected', 'warn');
}

function disconnectBLE() {
  if (bleDevice?.gatt.connected) bleDevice.gatt.disconnect();
  onBleDisconnect();
}

function setBleDot(s) {
  document.getElementById('ble-dot').className    = s === 'connected' ? 'connected' : s === 'connecting' ? 'connecting' : '';
  document.getElementById('ble-label').textContent = s === 'connected' ? 'Connected' : s === 'connecting' ? '...' : 'BLE';
}

async function sendCmd(cmd) {
  if (!bleConnected || !cmdChar) return;
  try { await cmdChar.writeValueWithoutResponse(new TextEncoder().encode(cmd)); }
  catch(e) { console.warn('BLE send error:', e); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BLE NOTIFY HANDLER  ‚Äî  obstacle + SOS incoming
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onBLENotify(e) {
  const val = new TextDecoder().decode(e.target.value).trim();
  if (val === 'OK') return;

  // ‚îÄ‚îÄ Obstacle messages ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (val === 'OBS:CLEAR') {
    if (obstacleActive) {
      obstacleActive = false; lastObstacleLevel = 0; navPaused = false;
      updateObstacleUI(0, 0);
    }
    return;
  }
  if (val === 'OBS:NOTICE' || val === 'OBS:WARN' || val === 'OBS:DANGER') {
    const level = val === 'OBS:DANGER' ? 3 : val === 'OBS:WARN' ? 2 : 1;
    obstacleActive = true;
    if (level !== lastObstacleLevel) {
      // Vibrate only if settings allow
      const shouldVib = vibSettings.obstacle &&
        (level >= 2 || vibSettings.notice) &&
        vibUnlocked;
      if (shouldVib && navigator.vibrate) navigator.vibrate(VIBRATE[level]);
      lastObstacleLevel = level;
    }
    navPaused = vibSettings.pauseNav && (level >= 2);
    updateObstacleUI(level, val);
    return;
  }

  // ‚îÄ‚îÄ SOS button pressed on stick ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (val === 'SOS') {
    triggerSOS();
    return;
  }
}

// ‚îÄ‚îÄ Obstacle UI ‚Äî updates BOTH the nav bar AND the obstacle screen ‚îÄ‚îÄ‚îÄ‚îÄ
function updateObstacleUI(level, raw) {
  // ‚îÄ‚îÄ Nav screen bar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const bar = document.getElementById('obstacle-bar');
  if (bar) {
    const labels = ['', '‚ö† Obstacle nearby', '‚ö†Ô∏è WARNING ‚Äî slow down', 'üö® DANGER ‚Äî STOP!'];
    const cls    = ['', 'notice', 'warning', 'danger'];
    bar.className   = 'obstacle-bar' + (level > 0 ? ' ' + cls[level] : '');
    bar.textContent = level > 0 ? labels[level] : '';
  }

  // ‚îÄ‚îÄ Obstacle screen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const card      = document.getElementById('obs-main-card');
  const icon      = document.getElementById('obs-icon');
  const lblLevel  = document.getElementById('obs-level-label');
  const lblDist   = document.getElementById('obs-dist-label');
  const barFill   = document.getElementById('obs-bar-fill');

  const configs = {
    0: { icon:'üì°', label:'CLEAR',   dist:'No obstacle detected',  fill:0,   color:'var(--accent)',  cls:'' },
    1: { icon:'‚ö†Ô∏è', label:'NOTICE',  dist:'Obstacle within 150cm', fill:40,  color:'var(--accent3)', cls:'lvl1' },
    2: { icon:'üî∂', label:'WARNING', dist:'Obstacle within 80cm',  fill:70,  color:'#ff9800',        cls:'lvl2' },
    3: { icon:'üö®', label:'DANGER',  dist:'Obstacle within 30cm ‚Äî STOP!', fill:100, color:'var(--accent2)', cls:'lvl3' },
  };

  const cfg = configs[level] || configs[0];
  if (card)     { card.className = 'obs-main-card' + (cfg.cls ? ' ' + cfg.cls : ''); }
  if (icon)     icon.textContent     = cfg.icon;
  if (lblLevel) lblLevel.textContent = cfg.label;
  if (lblDist)  lblDist.textContent  = cfg.dist;
  if (barFill)  { barFill.style.width = cfg.fill + '%'; barFill.style.background = cfg.color; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OBSTACLE SCREEN ‚Äî VIBRATION SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function unlockVibration() {
  if (navigator.vibrate) {
    navigator.vibrate(200);
    vibUnlocked = true;
    const b = document.getElementById('vib-unlock-banner');
    b.textContent = '‚úÖ Vibration unlocked!';
    b.classList.add('unlocked');
    b.onclick = null;
  } else {
    document.getElementById('vib-unlock-banner').textContent = '‚ùå Vibration not supported on this device';
  }
}

function loadVibSettings() {
  try {
    const s = JSON.parse(localStorage.getItem('vib_settings') || '{}');
    vibSettings.obstacle = s.obstacle !== false;
    vibSettings.notice   = s.notice   !== false;
    vibSettings.pauseNav = s.pauseNav !== false;
  } catch { /* use defaults */ }
  document.getElementById('tog-vib-obstacle').checked = vibSettings.obstacle;
  document.getElementById('tog-vib-notice').checked   = vibSettings.notice;
  document.getElementById('tog-pause-nav').checked    = vibSettings.pauseNav;
}

function saveVibSettings() {
  vibSettings.obstacle = document.getElementById('tog-vib-obstacle').checked;
  vibSettings.notice   = document.getElementById('tog-vib-notice').checked;
  vibSettings.pauseNav = document.getElementById('tog-pause-nav').checked;
  localStorage.setItem('vib_settings', JSON.stringify(vibSettings));
  toast('Settings saved', 'ok', 1500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadSosContact() {
  const c = JSON.parse(localStorage.getItem('sos_contact') || '{}');
  if (c.name)  document.getElementById('sos-inp-name').value  = c.name;
  if (c.phone) document.getElementById('sos-inp-phone').value = c.phone;
  if (c.msg)   document.getElementById('sos-inp-msg').value   = c.msg;
  if (c.name)  document.getElementById('save-sos-msg').textContent = '‚úì Loaded: ' + c.name;
}

function saveSosContact() {
  const name  = document.getElementById('sos-inp-name').value.trim();
  const phone = document.getElementById('sos-inp-phone').value.trim().replace(/\D/g,'');
  const msg   = document.getElementById('sos-inp-msg').value.trim();
  if (!name)  { document.getElementById('save-sos-msg').textContent = '‚ö† Enter a name'; return; }
  if (!phone) { document.getElementById('save-sos-msg').textContent = '‚ö† Enter a phone number'; return; }
  localStorage.setItem('sos_contact', JSON.stringify({ name, phone, msg }));
  document.getElementById('save-sos-msg').textContent = '‚úÖ Saved: ' + name;
  toast('Emergency contact saved!', 'ok');
}

function triggerSOS() {
  const c = JSON.parse(localStorage.getItem('sos_contact') || '{}');

  // Flash SOS in topbar
  document.getElementById('sos-indicator').classList.add('show');
  setTimeout(() => document.getElementById('sos-indicator').classList.remove('show'), 10000);

  // Update SOS panel
  setSosPanel('üÜò', 'SOS TRIGGERED!', 'Contacting ' + (c.name || '...'), true);
  switchTab('sos');

  // Vibrate phone
  if (navigator.vibrate) navigator.vibrate([500,100,500,100,500,100,500]);

  if (!c.phone) {
    setSosPanel('‚ö†Ô∏è', 'NO CONTACT!', 'Go to SOS tab and save emergency contact', true);
    toast('‚ö† No emergency contact! Save one in SOS tab', 'err', 5000);
    return;
  }

  const baseMsg = c.msg || 'I need help! Please come immediately.';

  // Get GPS then open WhatsApp
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        const mapsUrl = `https://maps.google.com/?q=${pos.coords.latitude.toFixed(6)},${pos.coords.longitude.toFixed(6)}`;
        const fullMsg = `üÜò SOS - SmartStick Emergency üÜò\n\n${baseMsg}\n\nüìç My location:\n${mapsUrl}`;
        window.location.href = 'https://wa.me/' + c.phone + '?text=' + encodeURIComponent(fullMsg);
      },
      () => {
        const fullMsg = `üÜò SOS - SmartStick Emergency üÜò\n\n${baseMsg}\n\n(Location unavailable)`;
        window.location.href = 'https://wa.me/' + c.phone + '?text=' + encodeURIComponent(fullMsg);
      },
      { enableHighAccuracy: true, timeout: 5000 }
    );
  } else {
    const fullMsg = `üÜò SOS - SmartStick Emergency üÜò\n\n${baseMsg}`;
    window.location.href = 'https://wa.me/' + c.phone + '?text=' + encodeURIComponent(fullMsg);
  }

  setTimeout(() => setSosPanel('üü¢', 'READY', 'Press button on stick to trigger SOS', false), 10000);
}

function setSosPanel(emoji, title, sub, active) {
  document.getElementById('sos-emoji').textContent = emoji;
  document.getElementById('sos-title').textContent = title;
  document.getElementById('sos-sub').textContent   = sub;
  document.getElementById('sos-status-panel').classList.toggle('active', active);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startGPS() {
  const el = document.getElementById('gps-text');
  el.textContent = 'üìç Getting GPS...'; el.className = '';
  if (!navigator.geolocation) { el.textContent = '‚ùå GPS not supported'; el.className = 'err'; return; }
  navigator.geolocation.getCurrentPosition(
    pos => {
      userLat = pos.coords.latitude; userLng = pos.coords.longitude;
      el.textContent = `üìç GPS OK (¬±${Math.round(pos.coords.accuracy)}m)`; el.className = 'ok';
      refreshRoomGrid();
    },
    () => { el.textContent = '‚ö†Ô∏è GPS denied'; el.className = 'err'; refreshRoomGrid(); },
    { enableHighAccuracy: true, timeout: 12000 }
  );
  if (watchId) navigator.geolocation.clearWatch(watchId);
  watchId = navigator.geolocation.watchPosition(
    pos => {
      userLat = pos.coords.latitude; userLng = pos.coords.longitude;
      updateDistRemaining();
      if (navActive) autoNavTick();
    },
    () => {},
    { enableHighAccuracy: true, maximumAge: 1000 }
  );
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COMPASS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startCompass() {
  if (typeof DeviceOrientationEvent !== 'undefined' &&
      typeof DeviceOrientationEvent.requestPermission === 'function') {
    DeviceOrientationEvent.requestPermission()
      .then(s => { if (s === 'granted') window.addEventListener('deviceorientation', onOrientation, true); })
      .catch(() => {});
  } else {
    window.addEventListener('deviceorientation', onOrientation, true);
  }
}

function onOrientation(e) {
  let heading = e.webkitCompassHeading || (e.alpha != null ? 360 - e.alpha : null);
  if (heading == null) return;
  userHeading = Math.round(heading);
  document.getElementById('compass-heading').textContent = userHeading + '¬∞';
  document.getElementById('compass-needle').style.transform = `rotate(${userHeading}deg)`;
  if (navActive && destRoom) updateCompassHint();
}

function updateCompassHint() {
  if (!userLat || !destRoom?.lat || userHeading === null) return;
  const bearing = getBearing(userLat, userLng, destRoom.lat, destRoom.lng);
  const diff    = ((bearing - userHeading + 540) % 360) - 180;
  document.getElementById('target-bearing').textContent        = Math.round(bearing) + '¬∞';
  document.getElementById('compass-arc').style.strokeDashoffset = 138 * (Math.abs(diff) / 180);
  const hint = Math.abs(diff) < 20 ? '‚úÖ Facing destination'
    : diff > 0 ? `‚Üª Turn right ${Math.round(diff)}¬∞`
    : `‚Ü∫ Turn left ${Math.round(-diff)}¬∞`;
  document.getElementById('compass-hint').textContent = hint;
}

function getBearing(lat1, lng1, lat2, lng2) {
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const y = Math.sin(dLng) * Math.cos(lat2 * Math.PI / 180);
  const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) -
            Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLng);
  return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
}

function haversine(lat1, lng1, lat2, lng2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function updateDistRemaining(dist) {
  if (dist === undefined) {
    if (!userLat || !destRoom?.lat) return;
    dist = haversine(userLat, userLng, destRoom.lat, destRoom.lng);
  }
  const el = document.getElementById('dist-remaining');
  if (el) el.textContent = dist < 1000 ? Math.round(dist) + 'm away' : (dist/1000).toFixed(2) + 'km away';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startNavTo(room) {
  if (!bleConnected) { toast('Connect SmartStick first!', 'warn'); return; }
  if (!room.lat)     { toast('No GPS for ' + room.name, 'warn', 4000); return; }
  if (!userLat)      { toast('GPS not ready yet', 'warn'); return; }

  destRoom = room; navActive = true;
  lastSentCmd = ''; lastSentTime = 0; pendingNavCmd = ''; pendingCount = 0;

  document.getElementById('nav-dest-name').textContent     = room.icon + ' ' + room.name;
  document.getElementById('arrived-room-name').textContent = 'You reached: ' + room.name;
  document.getElementById('nav-active').classList.add('show');
  document.getElementById('room-grid-wrap').style.display  = 'none';

  setNavDisplay('S', 'Starting navigation...');
  updateDistRemaining();
  toast('Navigation started ‚Üí auto-tracking', 'ok');
  navTimer = setInterval(autoNavTick, CHECK_INTERVAL);
  autoNavTick();
}

async function autoNavTick() {
  if (!navActive || !destRoom) return;
  if (navPaused) { document.getElementById('dbg-cmd').textContent = 'PAUSED'; return; }

  document.getElementById('dbg-gps').textContent     = userLat ? `${userLat.toFixed(5)},${userLng.toFixed(5)}` : 'no fix';
  document.getElementById('dbg-heading').textContent = userHeading !== null ? userHeading + '¬∞' : 'no compass';
  document.getElementById('dbg-ble').textContent     = bleConnected ? 'ok' : 'NO';

  if (userLat && destRoom.lat) {
    const dist    = haversine(userLat, userLng, destRoom.lat, destRoom.lng);
    const bearing = getBearing(userLat, userLng, destRoom.lat, destRoom.lng);
    const diff    = ((bearing - userHeading + 540) % 360) - 180;
    updateDistRemaining(dist);
    document.getElementById('dbg-bearing').textContent = Math.round(bearing) + '¬∞';
    document.getElementById('dbg-diff').textContent    = Math.round(diff) + '¬∞';
    document.getElementById('dbg-dist').textContent    = Math.round(dist) + 'm';
    if (dist <= ARRIVE_THRESHOLD) { triggerArrived(); return; }
  }

  const cmd = calcDirection();
  document.getElementById('dbg-cmd').textContent = cmd;
  const now = Date.now();

  if (cmd === pendingNavCmd) pendingCount++;
  else { pendingNavCmd = cmd; pendingCount = 1; }

  if ((pendingCount >= CONFIRM_TICKS && cmd !== lastSentCmd) || (now - lastSentTime) >= REPEAT_INTERVAL) {
    lastSentCmd = cmd; lastSentTime = now;
    await sendCmd(cmd);
    setNavDisplay(cmd);
    updateCompassHint();
  }
}

function calcDirection() {
  if (userHeading === null || !userLat || !destRoom?.lat) return 'S';
  const bearing = getBearing(userLat, userLng, destRoom.lat, destRoom.lng);
  const diff    = ((bearing - userHeading + 540) % 360) - 180;
  const INNER   = TURN_THRESHOLD - 15;
  if (lastSentCmd === 'R') return diff > INNER  ? 'R' : diff < -TURN_THRESHOLD ? 'L' : 'S';
  if (lastSentCmd === 'L') return diff < -INNER ? 'L' : diff > TURN_THRESHOLD  ? 'R' : 'S';
  if (diff >  TURN_THRESHOLD) return 'R';
  if (diff < -TURN_THRESHOLD) return 'L';
  return 'S';
}

function setNavDisplay(cmd, overrideLabel) {
  const d = DIR[cmd] || DIR.S;
  const arrow = document.getElementById('nav-arrow');
  arrow.textContent = d.arrow;
  arrow.classList.remove('pop'); void arrow.offsetWidth; arrow.classList.add('pop');
  document.getElementById('nav-dir-label').textContent = overrideLabel || d.label;
  document.getElementById('nav-beeps').textContent     = d.beeps;
}

function cancelNav() {
  navActive = false; clearInterval(navTimer); navTimer = null; destRoom = null; lastSentCmd = '';
  document.getElementById('nav-active').classList.remove('show');
  document.getElementById('room-grid-wrap').style.display = 'block';
  sendCmd('X'); refreshRoomGrid();
}

function triggerArrived() {
  navActive = false; clearInterval(navTimer); navTimer = null;
  sendCmd('A'); setNavDisplay('A');
  setTimeout(() => document.getElementById('arrived-overlay').classList.add('show'), 800);
}

function dismissArrived() {
  document.getElementById('arrived-overlay').classList.remove('show');
  cancelNav();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ROOMS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadRooms() {
  try { rooms = JSON.parse(localStorage.getItem('campus_rooms') || '[]'); }
  catch { rooms = []; }
  refreshRoomGrid(); refreshRoomList();
}

function saveRooms() { localStorage.setItem('campus_rooms', JSON.stringify(rooms)); }

async function captureGPS() {
  const btn = document.getElementById('btn-capture-gps');
  const info = document.getElementById('captured-coords');
  btn.disabled = true; btn.textContent = '‚è≥ Capturing...';
  info.textContent = 'Getting GPS fix...'; info.className = '';
  await new Promise(res => {
    navigator.geolocation.getCurrentPosition(
      pos => {
        capturedLat = pos.coords.latitude; capturedLng = pos.coords.longitude;
        info.textContent = `‚úì ${capturedLat.toFixed(6)}, ${capturedLng.toFixed(6)} (¬±${Math.round(pos.coords.accuracy)}m)`;
        info.className = 'ok'; res();
      },
      err => { info.textContent = '‚ùå GPS failed: ' + err.message; capturedLat = null; capturedLng = null; res(); },
      { enableHighAccuracy: true, timeout: 12000 }
    );
  });
  btn.disabled = false; btn.textContent = 'üìç Stand at room door ‚Üí Capture GPS';
}

function addRoom() {
  const name = document.getElementById('inp-name').value.trim();
  const icon = document.getElementById('inp-icon').value.trim() || 'üö™';
  if (!name) { toast('Enter a room name', 'warn'); return; }
  rooms.push({ id: Date.now().toString(), name, icon, lat: capturedLat, lng: capturedLng });
  saveRooms(); refreshRoomGrid(); refreshRoomList();
  document.getElementById('inp-name').value = '';
  document.getElementById('inp-icon').value = 'üö™';
  document.getElementById('captured-coords').textContent = 'No location captured yet';
  document.getElementById('captured-coords').className = '';
  capturedLat = null; capturedLng = null;
  toast('Room added: ' + name, 'ok');
}

function deleteRoom(id) {
  rooms = rooms.filter(r => r.id !== id);
  saveRooms(); refreshRoomGrid(); refreshRoomList();
  toast('Room deleted', 'warn');
}

function refreshRoomGrid() {
  const grid = document.getElementById('room-grid');
  const noMsg = document.getElementById('no-rooms-msg');
  grid.innerHTML = '';
  if (!rooms.length) { noMsg.style.display = 'block'; return; }
  noMsg.style.display = 'none';
  rooms.forEach(room => {
    let dist = '‚Äî';
    if (userLat && room.lat) {
      const d = haversine(userLat, userLng, room.lat, room.lng);
      dist = d < 1000 ? Math.round(d) + 'm' : (d/1000).toFixed(1) + 'km';
    }
    const btn = document.createElement('div');
    btn.className = 'room-btn' + (destRoom?.id === room.id ? ' navigating' : '');
    btn.innerHTML = `
      <span class="room-badge ${room.lat ? 'has-loc' : ''}">${room.lat ? 'GPS ‚úì' : 'No GPS'}</span>
      <div class="room-icon">${room.icon}</div>
      <div class="room-name">${room.name}</div>
      <div class="room-dist">${dist}</div>`;
    btn.onclick = () => startNavTo(room);
    grid.appendChild(btn);
  });
}

function refreshRoomList() {
  const list = document.getElementById('room-list');
  list.innerHTML = '';
  if (!rooms.length) {
    list.innerHTML = '<div style="padding:16px;color:var(--muted);font-size:13px;text-align:center">No rooms yet. Add one above!</div>';
    return;
  }
  rooms.forEach(room => {
    const card = document.createElement('div');
    card.className = 'manage-card';
    card.innerHTML = `
      <div class="manage-card-icon">${room.icon}</div>
      <div class="manage-card-info">
        <h3>${room.name}</h3>
        <p class="${room.lat ? '' : 'no-loc'}">${room.lat ? `${room.lat.toFixed(5)}, ${room.lng.toFixed(5)}` : '‚ö† No GPS set'}</p>
      </div>
      <button class="btn-del" onclick="deleteRoom('${room.id}')">‚úï</button>`;
    list.appendChild(card);
  });
}

function exportMap() {
  const blob = new Blob([JSON.stringify({ version:1, rooms }, null, 2)], { type:'application/json' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = 'campus_map.json'; a.click();
  URL.revokeObjectURL(url);
  toast('Map exported!', 'ok');
}

function importMap() { document.getElementById('import-file').click(); }

function handleImport(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      if (!data.rooms || !Array.isArray(data.rooms)) throw new Error();
      rooms = data.rooms; saveRooms(); refreshRoomGrid(); refreshRoomList();
      toast(`Imported ${rooms.length} rooms!`, 'ok');
    } catch { toast('Import failed: invalid file', 'err'); }
  };
  reader.readAsText(file);
  e.target.value = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UI HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('screen-' + name).classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
}

let toastT = null;
function toast(msg, type = 'info', ms = 3000) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.className = 'show ' + type;
  clearTimeout(toastT);
  toastT = setTimeout(() => el.classList.remove('show'), ms);
}
</script>
</body>
</html>